package fr.nextgear.mesentretiensmoto.mvp.manage_maintenances;

import android.support.annotation.NonNull;

import com.hannesdorfmann.mosby3.mvp.MvpBasePresenter;
import com.squareup.otto.Subscribe;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.logging.Logger;

import fr.nextgear.mesentretiensmoto.core.App;
import fr.nextgear.mesentretiensmoto.core.database.MaintenanceDBManager;
import fr.nextgear.mesentretiensmoto.core.events.EventGetMaintenancesForBike;
import fr.nextgear.mesentretiensmoto.core.events.EventMarkMaintenanceDone;
<<<<<<< HEAD
import fr.nextgear.mesentretiensmoto.core.events.EventRefreshMaintenances;
=======
import fr.nextgear.mesentretiensmoto.core.events.EventUpdateMaintenancesListForBike;
>>>>>>> 3a2889380ceee18f9f0c90d60b52f9e9f70fd92b
import fr.nextgear.mesentretiensmoto.core.model.Bike;
import fr.nextgear.mesentretiensmoto.core.model.Maintenance;
import io.reactivex.Scheduler;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.schedulers.Schedulers;

/**
 * Created by FX98589 on 22/09/2017.
 */

public class PresenterManageMaintenances extends MvpBasePresenter<MVPManageMaintenances.View> implements MVPManageMaintenances.Presenter {

    private InteractorManageMaintenances mInteractorManageMaintenances;
    private boolean isMaintenancesDone;
    private Bike mCurrentBike;


<<<<<<< HEAD
    PresenterManageMaintenances(@NonNull final Bike poBike, boolean pbIsDone) {
=======
    public PresenterManageMaintenances(@NonNull final Bike poBike, boolean pbIsDone) {
        mCurrentBike = poBike;
>>>>>>> 3a2889380ceee18f9f0c90d60b52f9e9f70fd92b
        isMaintenancesDone = pbIsDone;
        mInteractorManageMaintenances = new InteractorManageMaintenances();
        App.getInstance().getMainThreadBus().register(this);
        getMaintenancesForBike(poBike);
    }

    @Override
    public void addMaintenance(@NonNull Bike poBike, @NonNull String psMaintenanceName, @NonNull float pfNbHours, boolean pbIsDone) {
        mInteractorManageMaintenances.addMaintenance(poBike, psMaintenanceName, pfNbHours, pbIsDone)
                .subscribeOn(Schedulers.newThread())
                .observeOn(AndroidSchedulers.mainThread())
<<<<<<< HEAD
                .subscribe(poMaintenance -> App.getInstance().getMainThreadBus().post(new EventRefreshMaintenances(poMaintenance.bike))
=======
                .subscribe(poMaintenance ->
                        {
//                            if (getView() != null && isViewAttached()) {
//                                getView().onMaintenanceAdded(poMaintenance);
//                            }
                            getMaintenancesForBike(mCurrentBike);
                        }
>>>>>>> 3a2889380ceee18f9f0c90d60b52f9e9f70fd92b

                        , throwable -> {
                        });
    }

    @Override
    public void getMaintenancesForBike(@NonNull Bike poBike) {
        mInteractorManageMaintenances.getMaintenancesForBike(poBike, isMaintenancesDone)
                .observeOn(AndroidSchedulers.mainThread())
                .subscribeOn(Schedulers.newThread())
                .subscribe(ploMaintenances -> {
                    if (getView() != null && isViewAttached()) {
                        getView().onRetrieveMaintenancesSuccess(ploMaintenances);
                    }
                }, throwable -> {
                    if (getView() != null && isViewAttached()) {
                        getView().onRetrieveMaintenancesError();
                    }
                }, () -> {

                });
    }

    @Override
    public void removeMaintenance(@NonNull Maintenance poMaintenanceToRemove) {
        mInteractorManageMaintenances.removeMaintenance(poMaintenanceToRemove)
                .observeOn(AndroidSchedulers.mainThread())
                .subscribeOn(Schedulers.newThread())
                .subscribe(() -> {

                        },
                        throwable -> {

                        });
    }

    @Override
    public void updateMaintenaceToDone(@NonNull Maintenance poMaintenance) {
        mInteractorManageMaintenances.setMaintenanceDone(poMaintenance)
                .observeOn(AndroidSchedulers.mainThread())
                .subscribeOn(Schedulers.newThread())
<<<<<<< HEAD
                .subscribe(() -> App.getInstance().getMainThreadBus().post(new EventRefreshMaintenances(poMaintenance.bike)),
=======
                .subscribe(() -> {
            App.getInstance().getMainThreadBus().post(new EventUpdateMaintenancesListForBike());
//                            if (getView() != null && isViewAttached()) {
//                                getView().onUpdateMaintenance(poMaintenance);
//                            }
                        },
>>>>>>> 3a2889380ceee18f9f0c90d60b52f9e9f70fd92b
                        throwable -> {
                            //TODO : handle error
                        });
    }

    @Subscribe
    public void onEventMarkMaintenanceDoneReceived(EventMarkMaintenanceDone poEvent) {
<<<<<<< HEAD
        if(poEvent.getMaintenance().isDone == isMaintenancesDone){
=======
        if(poEvent.getMaintenance().isDone == isMaintenancesDone) {
>>>>>>> 3a2889380ceee18f9f0c90d60b52f9e9f70fd92b
            if (getView() != null && isViewAttached()) {
                getView().onAskMarkMaitenanceDone(poEvent.getMaintenance());
            }
        }
    }

    @Subscribe
<<<<<<< HEAD
    public void onEventRefreshMaintenances(EventRefreshMaintenances poEvent){
        getMaintenancesForBike(poEvent.bike);
=======
    public void onEventUpdateMaintenancesListForBikeReceived(EventUpdateMaintenancesListForBike poEvent) {
        getMaintenancesForBike(mCurrentBike);
>>>>>>> 3a2889380ceee18f9f0c90d60b52f9e9f70fd92b
    }

}
